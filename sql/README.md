# SQL –ú–∏–≥—Ä–∞—Ü–∏–∏ –∏ –°–∫—Ä–∏–ø—Ç—ã

–≠—Ç–∞ –ø–∞–ø–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç SQL-—Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö Supabase –ø—Ä–æ–µ–∫—Ç–∞ FoxTaffy.

## –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏

### –ß–µ—Ä–µ–∑ Supabase Dashboard (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. –û—Ç–∫—Ä–æ–π—Ç–µ [Supabase Dashboard](https://app.supabase.com)
2. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø—Ä–æ–µ–∫—Ç FoxTaffy
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ SQL Editor
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –Ω—É–∂–Ω–æ–≥–æ SQL-—Ñ–∞–π–ª–∞
5. –í—Å—Ç–∞–≤—å—Ç–µ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏ –Ω–∞–∂–º–∏—Ç–µ "Run"

### –ß–µ—Ä–µ–∑ Supabase CLI

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Supabase CLI (–µ—Å–ª–∏ –µ—â—ë –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
# macOS/Linux
brew install supabase/tap/supabase

# –í–æ–π–¥–∏—Ç–µ –≤ Supabase
supabase login

# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –ø—Ä–æ–µ–∫—Ç—É
supabase link --project-ref –≤–∞—à-project-id

# –í—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é
supabase db execute --file sql/–∏–º—è_—Ñ–∞–π–ª–∞.sql
```

## –°–ø–∏—Å–æ–∫ –º–∏–≥—Ä–∞—Ü–∏–π

### fix_invalid_dates_in_cons.sql
**–°—Ç–∞—Ç—É—Å:** üî¥ **–ö–†–ò–¢–ò–ß–ù–û - –ü–†–ò–ú–ï–ù–ò–¢–¨ –î–õ–Ø PRODUCTION –ë–î**

**–¶–µ–ª—å:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞—Ç –≤ production –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –í production –ë–î –µ—Å—Ç—å –∑–∞–ø–∏—Å–∏ —Å –ø—É—Å—Ç—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏ –≤ –ø–æ–ª—è—Ö –¥–∞—Ç (`event_date`, `event_end_date`, `announced_date`)
- –ü—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤—ã–∑—ã–≤–∞—é—Ç –æ—à–∏–±–∫—É: `e.getDay is not a function` –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Ä–∞–±–æ—Ç—ã —Å –¥–∞—Ç–∞–º–∏
- Preview –¥–æ–º–µ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç, –∞ production - –Ω–µ—Ç (—Ä–∞–∑–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –ë–î)

**–†–µ—à–µ–Ω–∏–µ:**
- –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤—Å–µ—Ö –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫ –≤ `NULL` –¥–ª—è –ø–æ–ª–µ–π –¥–∞—Ç
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ constraints –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫ –≤ –±—É–¥—É—â–µ–º
- –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –∏ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**–ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å:**
```sql
-- –í–ê–ñ–ù–û: –ü—Ä–∏–º–µ–Ω—è–π—Ç–µ —Ç–æ–ª—å–∫–æ –¥–ª—è PRODUCTION –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ Supabase SQL Editor
-- –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
-- 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
-- 2. –ò—Å–ø—Ä–∞–≤–∏—Ç –≤—Å–µ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ –¥–∞—Ç–∞—Ö
-- 3. –î–æ–±–∞–≤–∏—Ç constraints
-- 4. –ü–æ–∫–∞–∂–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
```

**–í–ê–ñ–ù–û:** –≠—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è production –ë–î. –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –æ—á–∏—Å—Ç–∫–æ–π –∫—ç—à–∞ (Ctrl+Shift+R).

### setup_cons_rls_policies.sql
**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è **–ö–†–ò–¢–ò–ß–ù–û - –ù–ï–û–ë–•–û–î–ò–ú–û –ü–†–ò–ú–ï–ù–ò–¢–¨ –ù–ï–ú–ï–î–õ–ï–ù–ù–û**

**–¶–µ–ª—å:** –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–ª–∏—Ç–∏–∫ RLS (Row Level Security) –¥–ª—è —Ç–∞–±–ª–∏—Ü –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—à–∏–±–∫–∞: "new row violates row-level security policy for table 'cons'"
- RLS –≤–∫–ª—é—á–µ–Ω –¥–ª—è —Ç–∞–±–ª–∏—Ü, –Ω–æ –ø–æ–ª–∏—Ç–∏–∫–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- –ë–µ–∑ –ø–æ–ª–∏—Ç–∏–∫ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å, —á–∏—Ç–∞—Ç—å, –æ–±–Ω–æ–≤–ª—è—Ç—å –∏–ª–∏ —É–¥–∞–ª—è—Ç—å –∑–∞–ø–∏—Å–∏

**–†–µ—à–µ–Ω–∏–µ:**
- –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è —Ç–∞–±–ª–∏—Ü: `cons`, `con_links`, `con_features`, `con_photos`, `con_purchases`
- –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (SELECT, INSERT, UPDATE, DELETE) –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞

**–ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å:**
```sql
-- –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ setup_cons_rls_policies.sql –≤ Supabase SQL Editor
-- –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏
```

**–í–ê–ñ–ù–û:** –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω –¥–æ –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã —Å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º–∏, –∏–Ω–∞—á–µ –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–≤–µ—Ä—à–∞—Ç—å—Å—è –æ—à–∏–±–∫–æ–π RLS.

### fix_image_url_nullable.sql
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∏–º–µ–Ω–∏—Ç—å

**–¶–µ–ª—å:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è NOT NULL –¥–ª—è –ø–æ–ª—è `image_url` –≤ —Ç–∞–±–ª–∏—Ü–µ `con_photos`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü–æ–ª–µ `image_url` –±—ã–ª–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º (NOT NULL)
- –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ `file_path` –ø–æ–ª–µ `image_url` –º–æ–∂–µ—Ç –±—ã—Ç—å NULL
- –í–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞: "null value in column image_url violates not-null constraint"

**–†–µ—à–µ–Ω–∏–µ:**
- –£–±–∏—Ä–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ NOT NULL —Å –ø–æ–ª—è `image_url`
- –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ç–æ –ª–∏–±–æ —á–µ—Ä–µ–∑ URL, –ª–∏–±–æ —á–µ—Ä–µ–∑ file_path

**–ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å:**
```sql
-- –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ fix_image_url_nullable.sql
ALTER TABLE con_photos ALTER COLUMN image_url DROP NOT NULL;
```

### remove_attendance_status_constraint.sql
**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ UI —Å—Ç–∞—Ç—É—Å–æ–≤

**–¶–µ–ª—å:** –£–¥–∞–ª–µ–Ω–∏–µ CHECK constraint –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ JSON —Ñ–æ—Ä–º–∞—Ç–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ —É—á–∞—Å—Ç–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:**
- CHECK constraint —Ç—Ä–µ–±—É–µ—Ç, —á—Ç–æ–±—ã `attendance_status` –±—ã–ª –æ–¥–Ω–∏–º –∏–∑ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
- –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç JSON –æ–±—ä–µ–∫—Ç –≤–∏–¥–∞ `{"status": "planning", "roles": ["vip"]}`
- –í–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—à–∏–±–∫–∞: "new row for relation cons violates check constraint cons_attendance_status_check"

**–†–µ—à–µ–Ω–∏–µ:**
- –£–¥–∞–ª—è–µ–º CHECK constraint `cons_attendance_status_check`
- –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –ª—é–±–æ–π JSON —Ñ–æ—Ä–º–∞—Ç –≤ –ø–æ–ª–µ `attendance_status`

**–ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å:**
```sql
-- –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ remove_attendance_status_constraint.sql
ALTER TABLE cons DROP CONSTRAINT IF EXISTS cons_attendance_status_check;
```

### –î—Ä—É–≥–∏–µ —Å–∫—Ä–∏–ø—Ç—ã

- `remove_duplicate_photos.sql` - –û—á–∏—Å—Ç–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
- `add_ratings_system.sql` - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —Ä–µ–π—Ç–∏–Ω–≥–æ–≤
- `add_review_completed_field.sql` - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è review_completed
- `add_participation_statuses.sql` - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ —É—á–∞—Å—Ç–∏—è (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç)
- `set_default_attendance_status.sql` - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
- `setup_storage_policies.sql` - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–ª–∏—Ç–∏–∫ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞

## –ü–æ—Ä—è–¥–æ–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π

### –î–ª—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ (—Å –Ω—É–ª—è):

1. –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã (—Å–º. SETUP.md)
2. **`setup_cons_rls_policies.sql`** üî¥ **–ö–†–ò–¢–ò–ß–ù–û - –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø–µ—Ä–≤—ã–º –¥–µ–ª–æ–º**
3. `fix_image_url_nullable.sql`
4. `add_ratings_system.sql`
5. `add_review_completed_field.sql`
6. `add_participation_statuses.sql`
7. `set_default_attendance_status.sql`
8. **`remove_attendance_status_constraint.sql`** ‚ö†Ô∏è –í–∞–∂–Ω–æ –¥–ª—è –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã —Å—Ç–∞—Ç—É—Å–æ–≤
9. `setup_storage_policies.sql`

### –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ (production):

1. **`fix_invalid_dates_in_cons.sql`** üî¥ **–ö–†–ò–¢–ò–ß–ù–û - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ production**
2. `setup_cons_rls_policies.sql` (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω)
3. `remove_attendance_status_constraint.sql` (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω)

## –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–π

–ï—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è –≤—ã–∑–≤–∞–ª–∞ –ø—Ä–æ–±–ª–µ–º—ã, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Ç–∫–∞—Ç:

```sql
-- –û—Ç–∫–∞—Ç fix_image_url_nullable.sql
ALTER TABLE con_photos ALTER COLUMN image_url SET NOT NULL;
```

‚ö†Ô∏è **–í–Ω–∏–º–∞–Ω–∏–µ:** –û—Ç–∫–∞—Ç –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –æ—à–∏–±–∫–∞–º, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –Ω–æ–≤—É—é —Å—Ö–µ–º—É.

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –µ—ë —É—Å–ø–µ—à–Ω–æ—Å—Ç—å:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü—ã con_photos
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'con_photos';
```

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ Supabase Dashboard
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ö–µ–º—ã
3. –°–æ–∑–¥–∞–π—Ç–µ Issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ GitHub
